// DDS sine double LUT oscillator //

#define SAMPLE_RATE 44100
#define SPEAKER_PIN 11

const unsigned int LUTsize = 256;

const uint8_t table[LUTsize] PROGMEM = {
  0x80, 0x3C, 0x86, 0x42, 0x8C, 0x47, 0x92, 0x4D, 0x98, 0x53, 0x9E, 0x59, 
  0xA5, 0x5E, 0xAA, 0x65, 0xB0, 0x6B, 0xB6, 0x71, 0xBC, 0x77, 0xC1, 0x7D, 
  0xC6, 0x83, 0xCB, 0x89, 0xD0, 0x8F, 0xD5, 0x95, 0xDA, 0x9B, 0xDE, 0xA2, 
  0xE2, 0xA7, 0xE6, 0xAD, 0xEA, 0xB3, 0xED, 0xB9, 0xF0, 0xBE, 0xF3, 0xC4, 
  0xF5, 0xC9, 0xF8, 0xCE, 0xFA, 0xD3, 0xFB, 0xD7, 0xFD, 0xDC, 0xFE, 0xE0, 
  0xFE, 0xE4, 0xFF, 0xE8, 0xFF, 0xEB, 0xFF, 0xEE, 0xFE, 0xF1, 0xFE, 0xF4, 
  0xFD, 0xF6, 0xFB, 0xF9, 0xFA, 0xFA, 0xF8, 0xFC, 0xF5, 0xFD, 0xF3, 0xFE, 
  0xF0, 0xFF, 0xED, 0xFF, 0xEA, 0xFF, 0xE6, 0xFF, 0xE2, 0xFE, 0xDE, 0xFD, 
  0xDA, 0xFC, 0xD5, 0xFA, 0xD0, 0xF9, 0xCB, 0xF6, 0xC6, 0xF4, 0xC1, 0xF1, 
  0xBC, 0xEE, 0xB6, 0xEB, 0xB0, 0xE8, 0xAA, 0xE4, 0xA5, 0xE0, 0x9E, 0xDC, 
  0x98, 0xD7, 0x92, 0xD3, 0x8C, 0xCE, 0x86, 0xC9, 0x80, 0xC4, 0x7A, 0xBE, 
  0x74, 0xB9, 0x6E, 0xB3, 0x68, 0xAD, 0x62, 0xA7, 0x5B, 0xA2, 0x56, 0x9B, 
  0x50, 0x95, 0x4A, 0x8F, 0x44, 0x89, 0x3F, 0x83, 0x3A, 0x7D, 0x35, 0x77, 
  0x30, 0x71, 0x2B, 0x6B, 0x26, 0x65, 0x22, 0x5E, 0x1E, 0x59, 0x1A, 0x53, 
  0x16, 0x4D, 0x13, 0x47, 0x10, 0x42, 0x0D, 0x3C, 0x0B, 0x37, 0x08, 0x32, 
  0x06, 0x2D, 0x05, 0x29, 0x03, 0x24, 0x02, 0x20, 0x02, 0x1C, 0x01, 0x18, 
  0x01, 0x15, 0x01, 0x12, 0x02, 0x0F, 0x02, 0x0C, 0x03, 0x0A, 0x05, 0x07, 
  0x06, 0x06, 0x08, 0x04, 0x0B, 0x03, 0x0D, 0x02, 0x10, 0x01, 0x13, 0x01, 
  0x16, 0x01, 0x1A, 0x01, 0x1E, 0x02, 0x22, 0x03, 0x26, 0x04, 0x2B, 0x06, 
  0x30, 0x07, 0x35, 0x0A, 0x3A, 0x0C, 0x3F, 0x0F, 0x44, 0x12, 0x4A, 0x15, 
  0x50, 0x18, 0x56, 0x1C, 0x5B, 0x20, 0x62, 0x24, 0x68, 0x29, 0x6E, 0x2D, 
  0x74, 0x32, 0x7A, 0x37
};

volatile uint8_t outputvalue = 127;

struct oscillator {
  uint32_t phase;
  uint32_t phase_increment;
  uint16_t amplitude;
} o1;

uint32_t phaseinc(float freq) {
  return (uint32_t)(freq * LUTsize * (1UL << 16) / SAMPLE_RATE);
}

ISR(TIMER1_COMPA_vect) {

  uint8_t index = o1.phase >> 16;
  uint8_t sample = pgm_read_byte(&table[index]);

  uint8_t amp = o1.amplitude >> 8;
  int16_t s = (int16_t)sample - 128;

  outputvalue = 127 + ((s * amp) >> 8);
  OCR2A = outputvalue;

  o1.phase += o1.phase_increment;

}

void setup() {

  pinMode(SPEAKER_PIN, OUTPUT);

  TCCR2A = _BV(COM2A1) | _BV(WGM21) | _BV(WGM20);
  TCCR2B = _BV(CS20);
  OCR2A = 127;

  cli();

  TCCR1A = 0;
  TCCR1B = _BV(WGM12) | _BV(CS10);
  OCR1A  = (F_CPU / SAMPLE_RATE) - 1;
  TIMSK1 = _BV(OCIE1A);

  sei();

  o1.phase = 0;
  o1.phase_increment = phaseinc(220.0);
  o1.amplitude = 65535;

}

void loop() {

}